<div class="source-control-wrapper" *ngIf="!unavailable">
  <div class="source-control-lock-overlay" *ngIf="isLocked && isAuthenticated">
    <mat-icon>lock</mat-icon>
    <p>This repository has no remotes configured to push to.</p>
    <button
      class="source-control-configure-btn"
      (click)="configureRepository()"
    >
      <span
        *ngIf="repositoriesLoading"
        class="spinner-border spinner-border-sm mr-1"
      ></span>
      Configure remote repository
    </button>
  </div>
  <div class="source-control-lock-overlay" *ngIf="!isAuthenticated">
    <mat-icon>lock</mat-icon>
    <p>You need to authorize with GitHub to use version control features.</p>
    <button
      class="source-control-authorize-btn"
      (click)="authorizeWithGithub()"
    >
      <!-- <span *ngIf="importLoading" class="spinner-border spinner-border-sm mr-1"></span> -->
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        width="24"
        height="24"
      >
        <path
          fill="#FFF"
          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"
        ></path>
      </svg>
      Sign in with GitHub
    </button>
  </div>
  <div class="commit-wrapper">
    <form [formGroup]="commitForm" (ngSubmit)="commit()">
      <div class="commit-input-wrapper">
        <input
          type="text"
          formControlName="message"
          class="commit-message"
          placeholder="Commit message"
          [disabled]="submitting || pulling"
        />
        <button class="btn pull" matTooltip="Fetch and pull changes" (click)="openFetchAndPullPopup()" type="button">
          <mat-icon *ngIf="!pulling">download</mat-icon>
          <span
            *ngIf="pulling"
            class="spinner-border spinner-border-sm mr-1"
          ></span>
        </button>
        <app-fetch-and-pull-popup
            (click)="$event.stopPropagation()"
            [visible]="isFetchAndPullPopupVisible"
            (onCancel)="onCloseFetchAndPullPopup()"
            (onCreate)="onFetchAndPull()"
          ></app-fetch-and-pull-popup>
      </div>
      <button
        class="btn btn-primary commit-submit"
        [disabled]="
          f.message.value === '' || stagedArray.length === 0 || submitting || pulling
        "
      >
        <mat-icon *ngIf="!submitting">check</mat-icon>
        <span
          *ngIf="submitting"
          class="spinner-border spinner-border-sm mr-1"
        ></span>
        Commit
      </button>
    </form>
  </div>
  <div class="initial-load" *ngIf="initialLoading">
    <mat-spinner diameter="30"></mat-spinner>
    <p>Loading changes...</p>
  </div>
  <div class="changes-list" *ngIf="stagedArray.length !== 0 && !initialLoading">
    <div class="changes-header">
      <div class="changes-header-title">Staged Changes</div>
      <div class="changes-header-buttons">
        <button
          matTooltip="Unstage all changes"
          class="source-control-btn"
          (click)="unstageAllChanges()"
        >
          <mat-icon>remove</mat-icon>
        </button>
      </div>
    </div>
    <div class="changes-list-items">
      <div
        *ngFor="let staged of stagedArray"
        class="changes-list-item"
        (click)="showDiff(staged.id, true)"
      >
        <div class="changes-list-item-title">{{ staged.fileName }}</div>
        <div class="changes-list-item-buttons">
          <button
            matTooltip="Unstage changes"
            class="source-control-btn"
            (click)="removeFromStaged(staged)"
          >
            <mat-icon>remove</mat-icon>
          </button>
          <span
            class="changes-list-item-status"
            matTooltip="{{
              staged.deleted
                ? 'Deleted'
                : staged.modified
                ? 'Modified'
                : 'Untracked'
            }}"
            [ngClass]="{
              modified: staged.modified,
              untracked: !staged.modified && !staged.deleted,
              deleted: staged.deleted
            }"
          >
            {{ staged.deleted ? "D" : staged.modified ? "M" : "U" }}
          </span>
        </div>
      </div>
    </div>
  </div>
  <div class="changes-list" *ngIf="!initialLoading">
    <div class="changes-header">
      <div class="changes-header-title">Changes</div>
      <div class="changes-header-buttons">
        <button
          matTooltip="Discard all changes"
          class="source-control-btn"
          [disabled]="diffsArray.length === 0"
          (click)="discardAllChanges()"
        >
          <mat-icon>delete_outline</mat-icon>
        </button>
        <button
          matTooltip="Stage all changes"
          class="source-control-btn"
          [disabled]="diffsArray.length === 0"
          (click)="stageAllChanges()"
        >
          <mat-icon>add</mat-icon>
        </button>
      </div>
    </div>
    <div class="changes-list-items">
      <div
        *ngFor="let diff of diffsArray"
        class="changes-list-item"
        (click)="showDiff(diff.id)"
      >
        <div
          class="changes-list-item-title"
          [ngClass]="{ deleted: diff.deleted }"
        >
          {{ diff.fileName }}
        </div>
        <div class="changes-list-item-buttons">
          <button
            matTooltip="Discard changes"
            class="source-control-btn"
            (click)="$event.stopPropagation(); discardChanges(diff.id)"
          >
            <mat-icon>delete_outline</mat-icon>
          </button>
          <button
            matTooltip="Stage changes"
            class="source-control-btn"
            (click)="addToStaged(diff)"
          >
            <mat-icon>add</mat-icon>
          </button>
          <span
            class="changes-list-item-status"
            matTooltip="{{
              diff.deleted
                ? 'Deleted'
                : diff.modified
                ? 'Modified'
                : 'Untracked'
            }}"
            [ngClass]="{
              modified: diff.modified,
              untracked: !diff.modified && !diff.deleted,
              deleted: diff.deleted
            }"
          >
            {{ diff.deleted ? "D" : diff.modified ? "M" : "U" }}
          </span>
        </div>
      </div>
    </div>
  </div>
  <div class="github-resources">
    <div class="commits">
      <div class="github-resources-header" (click)="openPanel('commits')">
        <div
          class="github-resources-header-title"
          [ngClass]="{ opened: openedPanel === 'commits' }"
        >
          <mat-icon>keyboard_arrow_right</mat-icon>Commits
        </div>
        <div class="github-resources-header-buttons">
          <button
            matTooltip="Refresh"
            class="source-control-btn"
            (click)="$event.stopPropagation(); getCommits()"
          >
            <mat-icon>refresh</mat-icon>
          </button>
        </div>
      </div>
      <div
        class="github-resources-body"
        [ngClass]="{ opened: openedPanel === 'commits' }"
      >
        <div *ngIf="commits.length === 0" class="github-resources-body-empty">
          No commits found.
        </div>
        <div *ngFor="let commit of commits" class="github-resources-body-item">
          <div class="commit-info">
            <p>{{ commit.commit.message }}</p>
            <span>{{ commit.commit.author.name }}</span>
          </div>
          <div class="github-resources-body-item-buttons">
            <a
              href="{{ commit.html_url }}"
              target="_blank"
              matTooltip="Open Commit on Remote"
              class="source-control-btn"
            >
              <button class="source-control-btn">
                <mat-icon>open_in_new</mat-icon>
              </button>
            </a>
          </div>
        </div>
      </div>
    </div>
    <div class="branches">
      <div class="github-resources-header" (click)="openPanel('branches')">
        <div
          class="github-resources-header-title"
          [ngClass]="{ opened: openedPanel === 'branches' }"
        >
          <mat-icon>keyboard_arrow_right</mat-icon>Branches
        </div>
        <div class="github-resources-header-buttons">
          <button
            matTooltip="Checkout to a new branch"
            class="source-control-btn"
            (click)="$event.stopPropagation(); openNewBranchModal()"
          >
            <mat-icon>add</mat-icon>
          </button>
          <button
            matTooltip="Refresh"
            class="source-control-btn"
            (click)="$event.stopPropagation(); getBranches()"
          >
            <mat-icon>refresh</mat-icon>
          </button>
          <app-new-branch-popup
            (click)="$event.stopPropagation()"
            [visible]="isNewBranchPopupVisible"
            (onCancel)="onCloseCodeReviewPopup()"
            (onCreate)="onCreateBranch($event)"
          ></app-new-branch-popup>
        </div>
      </div>
      <div
        class="github-resources-body"
        [ngClass]="{ opened: openedPanel === 'branches' }"
      >
        <div *ngIf="branches.length === 0" class="github-resources-body-empty">
          No branches found.
        </div>
        <div
          *ngFor="let branch of branches"
          class="github-resources-body-item"
          [ngClass]="{ active: activeBranch === branch.name }"
        >
          <div class="branch-info">
            <mat-icon>share</mat-icon>
            <p>{{ branch.name }}</p>
          </div>
          <div class="github-resources-body-item-buttons">
            <!-- TODO: switch branch -->
            <button
              matTooltip="Switch to Branch"
              class="source-control-btn"
              (click)="
                $event.stopPropagation(); checkoutNewBranch(null, branch.name)
              "
            >
              <mat-icon>subdirectory_arrow_right</mat-icon>
            </button>
            <a
              href=""
              target="_blank"
              matTooltip="Open Branch on Remote"
              class="source-control-btn"
            >
              <button class="source-control-btn">
                <mat-icon>open_in_new</mat-icon>
              </button>
            </a>
          </div>
        </div>
      </div>
    </div>
    <div class="prs">
      <div class="github-resources-header" (click)="openPanel('prs')">
        <div
          class="github-resources-header-title"
          [ngClass]="{ opened: openedPanel === 'prs' }"
        >
          <mat-icon>keyboard_arrow_right</mat-icon>Pull Requests
        </div>
        <div class="github-resources-header-buttons">
          <button
            matTooltip="Refresh"
            class="source-control-btn"
            (click)="$event.stopPropagation(); getPullRequests()"
          >
            <mat-icon>refresh</mat-icon>
          </button>
        </div>
      </div>
      <div
        class="github-resources-body"
        [ngClass]="{ opened: openedPanel === 'prs' }"
      >
        <div *ngIf="prs.length === 0" class="github-resources-body-empty">
          No pull requests found.
        </div>
        <div *ngFor="let pr of prs" class="github-resources-body-item">
          <div class="commit-info">
            <p>{{ pr.title }}</p>
            <span>{{ pr.user.login }}</span>
          </div>
          <div class="github-resources-body-item-buttons">
            <a
              href="{{ pr.html_url }}"
              target="_blank"
              matTooltip="Open Pull Request on Remote"
              class="source-control-btn"
            >
              <button class="source-control-btn">
                <mat-icon>open_in_new</mat-icon>
              </button>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="source-control-wrapper" *ngIf="unavailable">
  <div class="source-control-lock-overlay">
    <mat-icon>lock</mat-icon>
    <p>Source control is not available for this repository</p>
  </div>
</div>
